---
title: "Optimal ID equity analysis report"

header-includes:
    - \usepackage{caption}

params:
  data: NA
  file: NA
  run_notes: NA
  filter_group: NA
  data_filter_string: NA
  group_filter_string: NA
  filter_ref_grp1: NA
  filter_ref_grp2: NA
  filter_ref_grp3: NA
  group: NA
  reference_grp1: NA
  reference_grp2: NA
  assessments: NA
  weights: NA
  nom: NA
  nom_cutoff: NA
  mean_cutoff: NA
  baseline_id_var: NA
  equity_tbl: NA
  group_stats_tbl: NA

---


\captionsetup[table]{labelformat=empty}


```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(data.table)
library(kableExtra)
library(flextable)
library(knitr)
library(rmarkdown)
library(officer)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      fig.width=11, 
                      fig.height=8, 
                      dpi=150, 
                      ft.align = "left",
                      tab.cap.pre=' ', 
                      tab.cap.sep='',
                      tab.cap='',
                      tab.cap.tnd="")

set_flextable_defaults(fonts_ignore=TRUE)
```

This report was created using the [Optimal ID equity explorer app](https://mmcbee.shinyapps.io/OptimalID_Equity_shiny/). It was generated on `r format(Sys.time(), '%d %B %Y')` at `r format(Sys.time(), '%H:%M')`.




`r ifelse(params$run_notes != '', paste("**Notes**:", params$run_notes), '')`


```{r}
# construct filtering and group selection strings
if (!is.null(params$filter_group)) {

      data_filter_string = paste0(params$filter_group[1], " == (",
                                  toString(params$filter_ref_grp1), ")")


      if (length(params$filter_group) >= 2) {

        data_filter_string = paste0(data_filter_string, " & ",
                                      params$filter_group[2], " == (",
                                      toString(params$filter_ref_grp2), ")")
        }

      if (length(params$filter_group) >= 3) {

        data_filter_string = paste0(data_filter_string, " & ",
                                      params$filter_group[3], " == (",
                                      toString(params$filter_ref_grp3), ")")
        }

    } else if (is.null(params$filter_group)) {
      data_filter_string = 'No data filtering applied (all rows selected)'
    }


if (!is.null(params$group)) {

      filter_string = paste0(params$group[1], " == (",
                                  toString(params$reference_grp1), ")")


      if (length(params$group) >= 2) {

        filter_string = paste0(filter_string, " & ",
                                      params$group[2], " == (",
                                      toString(params$reference_grp2), ")")
        }

    } else if (is.null(params$group)) {
      filter_string = 'No equity groups selected'
    }


```


```{r}
settings_tbl = data.frame(
  Parameter = c('Uploaded file', 
                'Data filtering', 
                'Group(s) selected for equity analysis',
                'Reference equity group',
                'Baseline identification indicator variable name',
                'Nomination (phase-1) assessment',
                'Nomination (phase-1) percentile cutoff',
                'Phase-2 assessments',
                'Phase-2 assessment weights',
                'Phase-2 percentile cutoff'),
  Setting = c(params$file, 
              toString(data_filter_string),
              toString(params$group),
              toString(filter_string),
              params$baseline_id_var,
              params$nom,
              toString(round(params$nom_cutoff, 3)),
              toString(params$assessments),
              toString(paste0(round(params$weights, 3))),
              round(params$mean_cutoff, 3)
  ))
              
              
              

settings_tbl %>% flextable() %>% autofit() %>% theme_zebra() %>% set_caption(
  caption = 'Table 1: Settings',
  autonum = run_autonum(),
  style = "paragraph",
  html_escape = TRUE
)
```

<br>


```{r, warnings=FALSE}
params$equity_tbl %>% flextable() %>% autofit() %>% theme_zebra() %>% set_caption(
  caption = 'Table 2: Population size and equity metrics',
  autonum = NULL,
  style = "Table Caption",
  html_escape = TRUE
)
```

<br>

```{r, warnings=FALSE}
params$group_stats_tbl %>% regulartable() %>% autofit() %>% theme_zebra() %>% set_caption(
  caption = 'Table 3: Assessment descriptive statistics by group',
  autonum = NULL,
  style = "Table Caption",
  html_escape = TRUE
)
```

<!-- -->


```{r}

metrics = c("Count", "Representation Index", "Proportion Identified", 
                        "Relative Risk")

plots = lapply(metrics, equity_plot, data=params$data,
                    group=params$group,
                    reference_grp=params$group_filter_string,
                    assessments=params$assessments,
                    nom=params$nom,
                    nom_cutoff=params$nom_cutoff,
                    mean_cutoff=params$mean_cutoff,
                    baseline_id_var=params$baseline_id_var)

plots[[1]]$p

```

<br>

```{r}
plots[[2]]$p
```

<br>

```{r}
plots[[3]]$p
```

<br>

```{r}
plots[[4]]$p
```


